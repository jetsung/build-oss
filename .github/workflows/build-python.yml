---
name: Build Python Binary

on  :
  workflow_call:
    inputs:
      SOURCE:
        description: 项目源码地址
        required: true
        type: string
      VERSION:
        description: 构建版本号（可选，默认最新）
        required: false
        type: string
      BUILD_DIR:
        description: 构建目录（可选，默认项目根目录）
        required: false
        type: string
      EXTRA_ARGS:
        description: 扩展参数（可选，默认无）
        required: false
        type: string

jobs:
  build:
    # if: false
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set env
      run: |
        echo "SOURCE=${{ github.event.inputs.SOURCE }}" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.VERSION }}" >> $GITHUB_ENV
        echo "BUILD_DIR=${{ github.event.inputs.BUILD_DIR }}" >> $GITHUB_ENV
        echo "EXTRA_ARGS=${{ github.event.inputs.EXTRA_ARGS }}" >> $GITHUB_ENV
    - name: Checkout source code
      run: |
        git clone "${{ env.SOURCE }}" repo
        cd repo
        if [ -n "${{ env.VERSION }}" ]; then
          git checkout "${{ env.VERSION }}"
        fi
    - name: Get project name
      working-directory: ./repo
      run: |
        PROJECT_NAME=$(grep name pyproject.toml | awk -F'"' '{print $2}' | head -n 1)
        echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV          
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    # - name: Install uv with sh (DEBUG)
    #   run: |
    #     curl -L s.fx4.cn/uv | bash
    #     echo "source $HOME/.local/bin/env" >> $GITHUB_ENV
    - name: Check uv
      run: |
        uv --version
    - name: Build Python Binary
      working-directory: ./repo
      run: |
        uv sync
        uv build ${{ env.EXTRA_ARGS }}
    - name: Create Tag
      run: |
        if [ -n "${{ env.VERSION }}" ]; then
          TAG_NAME="${{ env.PROJECT_NAME }}-${{ env.VERSION }}"
        else
          TAG_NAME="${{ env.PROJECT_NAME }}-$(date +%Y%m%d)"
        fi
        git tag "$TAG_NAME"
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
    - name: Get short hash
      working-directory: ./repo
      run: |
        GIT_REV=$(git rev-parse --short HEAD)
        echo "GIT_REV=$GIT_REV" >> $GITHUB_ENV
        SOURCE_URL=${{ env.SOURCE }}
        echo "SOURCE_CODE_URL=${SOURCE_URL%.git}/tree/${GIT_REV}" >> $GITHUB_ENV
        echo "SOURCE_GIT_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          repo/dist/*.tar.gz
          repo/dist/*.whl
        body: |
          Date: ${{ env.SOURCE_GIT_DATE }}
          Platform: **Python**
          Source: [${{ env.SOURCE }}](${{ env.SOURCE_CODE_URL }})
          Publish by [Jetsung Chan](https://github.com/jetsung)
        append_body: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
